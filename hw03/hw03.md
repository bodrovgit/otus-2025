[Назад, к списку домашних заданий](../README.md)
# Домашнее задание №3. Построение Underlay сети(ISIS).
## 1. План работ.
1. Скопировать стенд с домашнего задания №1.
2. Настроить ISIS на spine и leaf коммутаторах
3. Убедиться в наличии связности между коммутаторами, с фиксацией результатов.
4. Сохранить конфигурацию сетевого оборудования.

## 2. Схема топологии CLOS.
![Мое фото](../L1.png)

## 3. Адресное пространство для Underlay.
### Таблица 1. Адресное пространство.
|Адресация|Назначение|
|--------|--------|
|10.0.1.**\<SN\>**/32|loopback интерфейсы для spine, где SN = 1-255|
|10.1.1.**\<LN\>**/32|loopback интерфейсы для leaf, где LN = 1-255|
|10.2.**\<SN\>**.**\<N\>**/30|p2p линки между spine и leaf, где SN = номер spine, N = 0-255|
|10.0.4.0/16|Overlay|
### Таблица 2. Сетевые адреса интерфейсов.
|Оборудование|Интерфейс|Адрес|
|--------|--------|----------|
|spine1|loopback1|10.0.1.1/32|
|spine2|loopback1|10.0.1.2/32|
|leaf1|loopback1|10.1.1.1/32|
|leaf2|loopback1|10.1.1.2/32|
|leaf3|loopback1|10.1.1.3/32|
|spine1|Eth1|10.2.1.0/31|
|leaf1|Eth1|10.2.1.1/31|
|spine1|Eth2|10.2.1.2/31|
|leaf2|Eth1|10.2.1.3/31|
|spine1|Eth3|10.2.1.4/31|
|leaf3|Eth1|10.2.1.5/31|
|spine2|Eth1|10.2.2.0/31|
|leaf1|Eth2|10.2.2.1/31|
|spine2|Eth2|10.2.2.2/31|
|leaf2|Eth2|10.2.2.3/31|
|spine2|Eth3|10.2.2.4/31|
|leaf3|Eth2|10.2.2.5/31|
|pc1|Eth1|10.4.0.11/16|
|pc2|Eth1|10.4.0.12/16|
|pc3|Eth1|10.4.0.13/16|
|pc4|Eth1|10.4.0.14/16|
## 4. Настройки сетевого оборудования.
<details>
  <summary>spine1 configuration</summary>

  ```cisco
spine1#sh run
! Command: show running-config
! device: spine1 (vEOS-lab, EOS-4.27.0F)
!
! boot system flash:/vEOS-lab.swi
!
no aaa root
!
transceiver qsfp default-mode 4x10G
!
service routing protocols model ribd
!
hostname spine1
!
spanning-tree mode mstp
!
interface Ethernet1
   description leaf1
   no switchport
   ip address 10.2.1.0/31
   isis enable spine1
!
interface Ethernet2
   description leaf2
   no switchport
   ip address 10.2.1.2/31
   isis enable spine1
!
interface Ethernet3
   description leaf3
   no switchport
   ip address 10.2.1.4/31
   isis enable spine1
!
interface Loopback1
   ip address 10.0.1.1/32
   isis enable spine1
!
interface Management1
!
ip routing
!
ip prefix-list connected
   seq 10 permit 10.0.0.0/14
   seq 20 deny 0.0.0.0/0
!
route-map connected permit 10
   match ip address prefix-list connected
!
route-map connected deny 20
   match ip address prefix-list connected
!
router isis spine1
   net 49.0001.0100.0000.1001.00
   is-hostname spine1
   is-type level-2
   log-adjacency-changes
   redistribute connected route-map connected
   !
   address-family ipv4 unicast
!
end
spine1#
  ```
</details>

<details>
  <summary>spine2 configuration</summary>

  ```cisco
spine2#sh run
! Command: show running-config
! device: spine2 (vEOS-lab, EOS-4.27.0F)
!
! boot system flash:/vEOS-lab.swi
!
no aaa root
!
transceiver qsfp default-mode 4x10G
!
service routing protocols model ribd
!
hostname spine2
!
spanning-tree mode mstp
!
interface Ethernet1
   description leaf1
   no switchport
   ip address 10.2.2.0/31
   isis enable spine2
!
interface Ethernet2
   description leaf2
   no switchport
   ip address 10.2.2.2/31
   isis enable spine2
!
interface Ethernet3
   description leaf3
   no switchport
   ip address 10.2.2.4/31
   isis enable spine2
!
interface Loopback1
   ip address 10.0.1.2/32
   isis enable spine2
!
interface Management1
!
ip routing
!
ip prefix-list connected
   seq 10 permit 10.0.0.0/14
   seq 20 deny 0.0.0.0/0
!
route-map connected permit 10
   match ip address prefix-list connected
!
route-map connected deny 20
   match ip address prefix-list connected
!
router isis spine2
   net 49.0001.0100.0000.1002.00
   is-hostname spine2
   is-type level-2
   log-adjacency-changes
   redistribute connected route-map connected
   !
   address-family ipv4 unicast
!
end
spine2#
  ```
</details>

<details>
  <summary>leaf1 configuration</summary>

  ```cisco
leaf1#sh run
! Command: show running-config
! device: leaf1 (vEOS-lab, EOS-4.27.0F)
!
! boot system flash:/vEOS-lab.swi
!
no aaa root
!
transceiver qsfp default-mode 4x10G
!
service routing protocols model ribd
!
hostname leaf1
!
spanning-tree mode mstp
!
interface Ethernet1
   description spine1
   no switchport
   ip address 10.2.1.1/31
   isis enable leaf1
!
interface Ethernet2
   description spine2
   no switchport
   ip address 10.2.2.1/31
   isis enable leaf1
!
interface Ethernet3
!
interface Loopback1
   ip address 10.1.1.1/32
   isis enable leaf1
!
interface Management1
!
ip routing
!
ip prefix-list connected
   seq 10 permit 10.0.0.0/14
   seq 20 deny 0.0.0.0/0
!
route-map connected permit 10
   match ip address prefix-list connected
!
route-map connected deny 20
   match ip address prefix-list connected
!
router isis leaf1
   net 49.0001.0100.0100.1001.00
   is-hostname leaf1
   is-type level-2
   log-adjacency-changes
   redistribute connected route-map connected
   !
   address-family ipv4 unicast
!
end
leaf1#
  ```
</details>

<details>
  <summary>leaf2 configuration</summary>

  ```cisco
leaf2#sh run
! Command: show running-config
! device: leaf2 (vEOS-lab, EOS-4.27.0F)
!
! boot system flash:/vEOS-lab.swi
!
no aaa root
!
transceiver qsfp default-mode 4x10G
!
service routing protocols model ribd
!
hostname leaf2
!
spanning-tree mode mstp
!
interface Ethernet1
   description spine1
   no switchport
   ip address 10.2.1.3/31
   isis enable leaf2
!
interface Ethernet2
   description spine2
   no switchport
   ip address 10.2.2.3/31
   isis enable leaf2
!
interface Ethernet3
!
interface Loopback1
   ip address 10.1.1.2/32
   isis enable leaf2
!
interface Management1
!
ip routing
!
ip prefix-list connected
   seq 10 permit 10.0.0.0/14
   seq 20 deny 0.0.0.0/0
!
route-map connected permit 10
   match ip address prefix-list connected
!
route-map connected deny 20
   match ip address prefix-list connected
!
router isis leaf2
   net 49.0001.0100.0100.1002.00
   is-hostname leaf2
   is-type level-2
   log-adjacency-changes
   redistribute connected route-map connected
   !
   address-family ipv4 unicast
!
end
leaf2#
  ```
</details>

<details>
  <summary>leaf3 configuration</summary>

  ```cisco
leaf3#sh run
! Command: show running-config
! device: leaf3 (vEOS-lab, EOS-4.27.0F)
!
! boot system flash:/vEOS-lab.swi
!
no aaa root
!
transceiver qsfp default-mode 4x10G
!
service routing protocols model ribd
!
hostname leaf3
!
spanning-tree mode mstp
!
interface Ethernet1
   description spine1
   no switchport
   ip address 10.2.1.5/31
   isis enable leaf3
!
interface Ethernet2
   description spine2
   no switchport
   ip address 10.2.2.5/31
   isis enable leaf3
!
interface Ethernet3
!
interface Ethernet4
!
interface Loopback1
   ip address 10.1.1.3/32
   isis enable leaf3
!
interface Management1
!
ip routing
!
ip prefix-list connected
   seq 10 permit 10.0.0.0/14
   seq 20 deny 0.0.0.0/0
!
route-map connected permit 10
   match ip address prefix-list connected
!
route-map connected deny 20
   match ip address prefix-list connected
!
router isis leaf3
   net 49.0001.0100.0100.1003.00
   is-hostname leaf3
   is-type level-2
   log-adjacency-changes
   redistribute connected route-map connected
   !
   address-family ipv4 unicast
!
end
leaf3#
  ```
</details>

# Проверка сетевой связности.
<details>
  <summary>проверка соседства</summary>

  ```cisco
spine1#sh isis neighbors

Instance  VRF      System Id        Type Interface          SNPA              State Hold time   Circuit Id
spine1    default  leaf1            L2   Ethernet1          50:86:56:87:56:99 UP    8           leaf1.06
spine1    default  leaf2            L2   Ethernet2          50:45:f5:e6:28:83 UP    8           leaf2.06
spine1    default  leaf3            L2   Ethernet3          50:fe:bc:e8:91:26 UP    7           leaf3.07
  ```
  
  ```cisco
spine2#sh isis neighbors

Instance  VRF      System Id        Type Interface          SNPA              State Hold time   Circuit Id
spine2    default  leaf1            L2   Ethernet1          50:86:56:87:56:99 UP    6           leaf1.07
spine2    default  leaf2            L2   Ethernet2          50:45:f5:e6:28:83 UP    22          spine2.07
spine2    default  leaf3            L2   Ethernet3          50:fe:bc:e8:91:26 UP    8           leaf3.08
  ```
  
  ```cisco
leaf1#sh isis neighbors

Instance  VRF      System Id        Type Interface          SNPA              State Hold time   Circuit Id
leaf1     default  spine1           L2   Ethernet1          50:29:da:db:44:1a UP    23          leaf1.06
leaf1     default  spine2           L2   Ethernet2          50:73:3d:d6:94:dd UP    28          leaf1.07
  ```
</details>

<details>
  <summary>динамические маршруты</summary>

  ```cisco
spine1#sh ip route

VRF: default
Codes: C - connected, S - static, K - kernel,
       O - OSPF, IA - OSPF inter area, E1 - OSPF external type 1,
       E2 - OSPF external type 2, N1 - OSPF NSSA external type 1,
       N2 - OSPF NSSA external type2, B - BGP, B I - iBGP, B E - eBGP,
       R - RIP, I L1 - IS-IS level 1, I L2 - IS-IS level 2,
       O3 - OSPFv3, A B - BGP Aggregate, A O - OSPF Summary,
       NG - Nexthop Group Static Route, V - VXLAN Control Service,
       DH - DHCP client installed default route, M - Martian,
       DP - Dynamic Policy Route, L - VRF Leaked,
       G  - gRIBI, RC - Route Cache Route

Gateway of last resort is not set

 C        10.0.1.1/32 is directly connected, Loopback1
 I L2     10.0.1.2/32 [115/30] via 10.2.1.1, Ethernet1
                               via 10.2.1.3, Ethernet2
                               via 10.2.1.5, Ethernet3
 I L2     10.1.1.1/32 [115/20] via 10.2.1.1, Ethernet1
 I L2     10.1.1.2/32 [115/20] via 10.2.1.3, Ethernet2
 I L2     10.1.1.3/32 [115/20] via 10.2.1.5, Ethernet3
 C        10.2.1.0/31 is directly connected, Ethernet1
 C        10.2.1.2/31 is directly connected, Ethernet2
 C        10.2.1.4/31 is directly connected, Ethernet3
 I L2     10.2.2.0/31 [115/20] via 10.2.1.1, Ethernet1
 I L2     10.2.2.2/31 [115/20] via 10.2.1.3, Ethernet2
 I L2     10.2.2.4/31 [115/20] via 10.2.1.5, Ethernet3
spine1#
  ```

  ``` cisco
spine2#sh ip route

VRF: default
Codes: C - connected, S - static, K - kernel,
       O - OSPF, IA - OSPF inter area, E1 - OSPF external type 1,
       E2 - OSPF external type 2, N1 - OSPF NSSA external type 1,
       N2 - OSPF NSSA external type2, B - BGP, B I - iBGP, B E - eBGP,
       R - RIP, I L1 - IS-IS level 1, I L2 - IS-IS level 2,
       O3 - OSPFv3, A B - BGP Aggregate, A O - OSPF Summary,
       NG - Nexthop Group Static Route, V - VXLAN Control Service,
       DH - DHCP client installed default route, M - Martian,
       DP - Dynamic Policy Route, L - VRF Leaked,
       G  - gRIBI, RC - Route Cache Route

Gateway of last resort is not set

 I L2     10.0.1.1/32 [115/30] via 10.2.2.1, Ethernet1
                               via 10.2.2.3, Ethernet2
                               via 10.2.2.5, Ethernet3
 C        10.0.1.2/32 is directly connected, Loopback1
 I L2     10.1.1.1/32 [115/20] via 10.2.2.1, Ethernet1
 I L2     10.1.1.2/32 [115/20] via 10.2.2.3, Ethernet2
 I L2     10.1.1.3/32 [115/20] via 10.2.2.5, Ethernet3
 I L2     10.2.1.0/31 [115/20] via 10.2.2.1, Ethernet1
 I L2     10.2.1.2/31 [115/20] via 10.2.2.3, Ethernet2
 I L2     10.2.1.4/31 [115/20] via 10.2.2.5, Ethernet3
 C        10.2.2.0/31 is directly connected, Ethernet1
 C        10.2.2.2/31 is directly connected, Ethernet2
 C        10.2.2.4/31 is directly connected, Ethernet3
spine2#
  ```

  ``` cisco
leaf1#sh ip route

VRF: default
Codes: C - connected, S - static, K - kernel,
       O - OSPF, IA - OSPF inter area, E1 - OSPF external type 1,
       E2 - OSPF external type 2, N1 - OSPF NSSA external type 1,
       N2 - OSPF NSSA external type2, B - BGP, B I - iBGP, B E - eBGP,
       R - RIP, I L1 - IS-IS level 1, I L2 - IS-IS level 2,
       O3 - OSPFv3, A B - BGP Aggregate, A O - OSPF Summary,
       NG - Nexthop Group Static Route, V - VXLAN Control Service,
       DH - DHCP client installed default route, M - Martian,
       DP - Dynamic Policy Route, L - VRF Leaked,
       G  - gRIBI, RC - Route Cache Route

Gateway of last resort is not set

 I L2     10.0.1.1/32 [115/20] via 10.2.1.0, Ethernet1
 I L2     10.0.1.2/32 [115/20] via 10.2.2.0, Ethernet2
 C        10.1.1.1/32 is directly connected, Loopback1
 I L2     10.1.1.2/32 [115/30] via 10.2.1.0, Ethernet1
                               via 10.2.2.0, Ethernet2
 I L2     10.1.1.3/32 [115/30] via 10.2.1.0, Ethernet1
                               via 10.2.2.0, Ethernet2
 C        10.2.1.0/31 is directly connected, Ethernet1
 I L2     10.2.1.2/31 [115/20] via 10.2.1.0, Ethernet1
 I L2     10.2.1.4/31 [115/20] via 10.2.1.0, Ethernet1
 C        10.2.2.0/31 is directly connected, Ethernet2
 I L2     10.2.2.2/31 [115/20] via 10.2.2.0, Ethernet2
 I L2     10.2.2.4/31 [115/20] via 10.2.2.0, Ethernet2

leaf1#
  ```
</details>

<details>
  <summary>проверка консистентности LSDB</summary>

  ```cisco
spine1#sh isis database

IS-IS Instance: spine1 VRF: default
  IS-IS Level 2 Link State Database
    LSPID                 Seq Num   Cksum  Life  IS Flags
    spine1.00-00          12        50297  568   L2 <>
    spine2.00-00          14        59972  613   L2 <>
    spine2.07-00          4         36859  1047  L2 <>
    leaf1.00-00           15        38068  383   L2 <>
    leaf1.06-00           5         32526  1031  L2 <>
    leaf1.07-00           5         33034  1142  L2 <>
    leaf2.00-00           9         59225  1139  L2 <>
    leaf2.06-00           5         35839  1031  L2 <>
    leaf3.00-00           10        48751  477   L2 <>
    leaf3.07-00           4         37622  1031  L2 <>
    leaf3.08-00           4         38130  497   L2 <>
  ```

  ```cisco
spine2#sh isis database

IS-IS Instance: spine2 VRF: default
  IS-IS Level 2 Link State Database
    LSPID                 Seq Num   Cksum  Life  IS Flags
    spine1.00-00          12        50297  527   L2 <>
    spine2.00-00          14        59972  570   L2 <>
    spine2.07-00          4         36859  1003  L2 <>
    leaf1.00-00           15        38068  340   L2 <>
    leaf1.06-00           5         32526  989   L2 <>
    leaf1.07-00           5         33034  1100  L2 <>
    leaf2.00-00           9         59225  1096  L2 <>
    leaf2.06-00           5         35839  989   L2 <>
    leaf3.00-00           10        48751  435   L2 <>
    leaf3.07-00           4         37622  989   L2 <>
    leaf3.08-00           5         37619  1161  L2 <>
  ```

  ```cisco
leaf1#sh isis database

IS-IS Instance: leaf1 VRF: default
  IS-IS Level 2 Link State Database
    LSPID                 Seq Num   Cksum  Life  IS Flags
    spine1.00-00          12        50297  514   L2 <>
    spine2.00-00          14        59972  558   L2 <>
    spine2.07-00          4         36859  992   L2 <>
    leaf1.00-00           16        37557  1197  L2 <>
    leaf1.06-00           5         32526  975   L2 <>
    leaf1.07-00           5         33034  1086  L2 <>
    leaf2.00-00           9         59225  1084  L2 <>
    leaf2.06-00           5         35839  976   L2 <>
    leaf3.00-00           10        48751  422   L2 <>
    leaf3.07-00           4         37622  976   L2 <>
    leaf3.08-00           5         37619  1148  L2 <>
  ```
  
  ```cisco
leaf2#sh isis database

IS-IS Instance: leaf2 VRF: default
  IS-IS Level 2 Link State Database
    LSPID                 Seq Num   Cksum  Life  IS Flags
    spine1.00-00          12        50297  501   L2 <>
    spine2.00-00          14        59972  545   L2 <>
    spine2.07-00          4         36859  979   L2 <>
    leaf1.00-00           16        37557  1186  L2 <>
    leaf1.06-00           5         32526  963   L2 <>
    leaf1.07-00           5         33034  1074  L2 <>
    leaf2.00-00           9         59225  1070  L2 <>
    leaf2.06-00           5         35839  962   L2 <>
    leaf3.00-00           10        48751  410   L2 <>
    leaf3.07-00           4         37622  963   L2 <>
    leaf3.08-00           5         37619  1136  L2 <>
```
</details>

<details>
  <summary>трассировка между лифами</summary>

  ```cisco
leaf3#traceroute 10.1.1.1
traceroute to 10.1.1.1 (10.1.1.1), 30 hops max, 60 byte packets
 1  10.2.1.4 (10.2.1.4)  1.917 ms  1.993 ms  2.209 ms
 2  10.1.1.1 (10.1.1.1)  6.111 ms  6.433 ms  8.926 ms
  ```
</details>
  
[Назад, к списку домашних заданий](../README.md)
